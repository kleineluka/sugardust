---
import ConfigSection from "./ConfigSection.astro";
import ConfigToggle from "./ConfigToggle.astro";
import ConfigInput from "./ConfigInput.astro";
import type { PluginConfigFile } from "../types/plugin";

interface Props {
    config: PluginConfigFile;
    filePath?: string;
}

const { config, filePath } = Astro.props;

function getInputType(settingType: string): "text" | "number" | "path" {
    if (
        settingType === "Int32" ||
        settingType === "Single" ||
        settingType === "Double"
    ) {
        return "number";
    }
    return "text";
}

function looksLikePath(value: string): boolean {
    return (
        value.includes(":\\") || value.startsWith("/") || value.includes("\\")
    );
}
---

<!-- BepinEx .cfg Editor -->
<div class="config-editor" data-file-path={filePath}>
    <!-- Plugin Header -->
    <div class="plugin-header">
        <div class="plugin-info">
            <h2 class="plugin-name">{config.pluginName}</h2>
            <div class="plugin-meta">
                <span class="plugin-version">v{config.pluginVersion}</span>
                <span class="plugin-guid">{config.pluginGuid}</span>
            </div>
        </div>
        <div class="header-actions">
            <button
                class="action-button save-button"
                id="save-config"
                title="Save changes"
            >
                <!-- Generic sd card svg -->
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <path
                        d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
                    ></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Save
            </button>
            <!-- Generic rotating arrow(?) svg -->
            <button
                class="action-button reset-all-button"
                id="reset-all-config"
                title="Reset all to defaults"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"
                    ></path>
                    <path d="M3 3v5h5"></path>
                </svg>
                Reset All
            </button>
        </div>
    </div>

    <!-- Unsaved changes indicator -->
    <div class="unsaved-indicator" id="unsaved-indicator">
        <!-- ! -->
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
        >
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        You have unsaved changes
    </div>

    <!-- Config sections -->
    <div class="sections-container">
        {
            config.sections.map((section) => (
                <ConfigSection sectionName={section.name}>
                    <span slot="badge">{section.entries.length} settings</span>
                    {section.entries.map((entry) => {
                        const entryId = `${section.name}__${entry.key}`;

                        if (entry.type === "Boolean") {
                            return (
                                <ConfigToggle
                                    id={entryId}
                                    label={entry.key
                                        .replace(/([A-Z])/g, " $1")
                                        .trim()}
                                    description={entry.description}
                                    defaultValue={entry.defaultValue}
                                    checked={
                                        entry.value.toLowerCase() === "true"
                                    }
                                />
                            );
                        }
                        const isPath =
                            looksLikePath(entry.value) ||
                            looksLikePath(entry.defaultValue);

                        return (
                            <ConfigInput
                                id={entryId}
                                label={entry.key
                                    .replace(/([A-Z])/g, " $1")
                                    .trim()}
                                description={entry.description}
                                defaultValue={entry.defaultValue}
                                value={entry.value}
                                type={
                                    isPath ? "path" : getInputType(entry.type)
                                }
                            />
                        );
                    })}
                </ConfigSection>
            ))
        }
    </div>
</div>

<!-- CSS -->
<style>
    .config-editor {
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 100%;
        height: 100%;
    }

    .plugin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        padding: 20px 24px;
        background: linear-gradient(
            135deg,
            rgba(30, 90, 110, 0.8) 0%,
            rgba(50, 120, 140, 0.6) 100%
        );
        border: 3px solid #6ad8e8;
        border-radius: 16px;
        box-shadow:
            0 4px 20px rgba(0, 0, 0, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .plugin-info {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .plugin-name {
        margin: 0;
        font-size: 24px;
        font-weight: 800;
        color: #e5ffff;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        letter-spacing: 1px;
    }

    .plugin-meta {
        display: flex;
        gap: 16px;
        align-items: center;
    }

    .plugin-version {
        font-size: 14px;
        font-weight: 700;
        color: var(--hp-pink);
        background: rgba(232, 74, 138, 0.2);
        padding: 4px 12px;
        border-radius: 8px;
        border: 1px solid var(--hp-pink);
    }

    .plugin-guid {
        font-size: 11px;
        color: #95d5e5;
        font-family: monospace;
        opacity: 0.8;
    }

    .header-actions {
        display: flex;
        gap: 12px;
    }

    .action-button {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .save-button {
        background: linear-gradient(
            to top,
            var(--hp-teal),
            var(--hp-teal-light)
        );
        border: 2px solid var(--hp-teal-light);
        color: white;
        box-shadow: 0 4px 8px rgba(45, 184, 176, 0.3);
    }

    .save-button:hover {
        background: linear-gradient(to top, var(--hp-teal-light), #7de4dd);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(45, 184, 176, 0.4);
    }

    .save-button:active {
        transform: translateY(0);
    }

    .reset-all-button {
        background: linear-gradient(to top, #d86ab8, #e88fd0);
        border: 2px solid #f5b8e0;
        color: #fff5ff;
        box-shadow: 0 4px 8px rgba(216, 106, 184, 0.3);
    }

    .reset-all-button:hover {
        background: linear-gradient(to top, #e88fd0, #f5b8e0);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(216, 106, 184, 0.4);
    }

    .unsaved-indicator {
        display: none;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        background: linear-gradient(
            to right,
            rgba(216, 106, 184, 0.2),
            rgba(232, 143, 208, 0.1)
        );
        border: 2px solid #d86ab8;
        border-radius: 10px;
        color: #e88fd0;
        font-size: 13px;
        font-weight: 600;
    }

    .unsaved-indicator.visible {
        display: flex;
    }

    .sections-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
</style>

<!-- Saving & Resetting Logic -->
<script>
    function initConfigEditor() {
        const editor = document.querySelector(".config-editor") as HTMLElement;
        const unsavedIndicator = document.getElementById("unsaved-indicator");
        const saveButton = document.getElementById("save-config");
        const resetAllButton = document.getElementById("reset-all-config");

        let hasUnsavedChanges = false;
        const changes: Map<string, string> = new Map();

        function markUnsaved() {
            hasUnsavedChanges = true;
            unsavedIndicator?.classList.add("visible");
        }

        function markSaved() {
            hasUnsavedChanges = false;
            changes.clear();
            unsavedIndicator?.classList.remove("visible");
        }

        document.addEventListener("config-change", ((e: CustomEvent) => {
            const { entryId, value } = e.detail;
            changes.set(entryId, value);
            markUnsaved();
        }) as EventListener);

        saveButton?.addEventListener("click", async () => {
            const filePath = editor?.getAttribute("data-file-path");
            const event = new CustomEvent("config-save", {
                bubbles: true,
                detail: {
                    filePath,
                    changes: Object.fromEntries(changes),
                },
            });
            document.dispatchEvent(event);
            markSaved();
            saveButton.textContent = "Saved!";
            setTimeout(() => {
                saveButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save
                `;
            }, 1500);
        });

        resetAllButton?.addEventListener("click", () => {
            const toggles = document.querySelectorAll(
                ".config-toggle-container .toggle-checkbox",
            ) as NodeListOf<HTMLInputElement>;
            const inputs = document.querySelectorAll(
                ".config-input-container .config-input",
            ) as NodeListOf<HTMLInputElement>;
            toggles.forEach((toggle) => {
                const defaultValue = toggle.getAttribute("data-default");
                toggle.checked = defaultValue?.toLowerCase() === "true";
                const container = toggle.closest(".config-toggle-container");
                const entryId = container?.getAttribute("data-entry-id");
                if (entryId) {
                    changes.set(entryId, toggle.checked ? "true" : "false");
                }
            });

            inputs.forEach((input) => {
                const defaultValue = input.getAttribute("data-default") || "";
                input.value = defaultValue;
                const container = input.closest(".config-input-container");
                const entryId = container?.getAttribute("data-entry-id");
                if (entryId) {
                    changes.set(entryId, defaultValue);
                }
            });

            markUnsaved();
        });

        window.addEventListener("beforeunload", (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
            }
        });
    }

    document.addEventListener("DOMContentLoaded", initConfigEditor);
    document.addEventListener("astro:page-load", initConfigEditor);
</script>
